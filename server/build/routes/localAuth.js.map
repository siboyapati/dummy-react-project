{"version":3,"sources":["../../src/routes/localAuth.js"],"names":["router","post","requireLocalAuth","req","res","token","user","generateJWT","me","toJSON","json","next","error","Joi","validate","body","registerSchema","status","send","message","details","email","password","name","username","existingUser","User","findOne","newUser","provider","avatar","faker","image","registerUser","err","get","logout"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AAEA;;AACA;;AACA;;;;AAEA,MAAMA,MAAM,GAAG,sBAAf;AAEAA,MAAM,CAACC,IAAP,CAAY,QAAZ,EAAsBC,yBAAtB,EAAwC,CAACC,GAAD,EAAMC,GAAN,KAAc;AACpD,QAAMC,KAAK,GAAGF,GAAG,CAACG,IAAJ,CAASC,WAAT,EAAd;AACA,QAAMC,EAAE,GAAGL,GAAG,CAACG,IAAJ,CAASG,MAAT,EAAX;AACAL,EAAAA,GAAG,CAACM,IAAJ,CAAS;AAAEL,IAAAA,KAAF;AAASG,IAAAA;AAAT,GAAT;AACD,CAJD;AAMAR,MAAM,CAACC,IAAP,CAAY,WAAZ,EAAyB,OAAOE,GAAP,EAAYC,GAAZ,EAAiBO,IAAjB,KAA0B;AACjD,QAAM;AAAEC,IAAAA;AAAF,MAAYC,aAAIC,QAAJ,CAAaX,GAAG,CAACY,IAAjB,EAAuBC,0BAAvB,CAAlB;;AACA,MAAIJ,KAAJ,EAAW;AACT,WAAOR,GAAG,CAACa,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAAEC,MAAAA,OAAO,EAAEP,KAAK,CAACQ,OAAN,CAAc,CAAd,EAAiBD;AAA5B,KAArB,CAAP;AACD;;AAED,QAAM;AAAEE,IAAAA,KAAF;AAASC,IAAAA,QAAT;AAAmBC,IAAAA,IAAnB;AAAyBC,IAAAA;AAAzB,MAAsCrB,GAAG,CAACY,IAAhD;;AAEA,MAAI;AACF,UAAMU,YAAY,GAAG,MAAMC,cAAKC,OAAL,CAAa;AAAEN,MAAAA;AAAF,KAAb,CAA3B;;AAEA,QAAII,YAAJ,EAAkB;AAChB,aAAOrB,GAAG,CAACa,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB;AAAEC,QAAAA,OAAO,EAAE;AAAX,OAArB,CAAP;AACD;;AAED,QAAI;AACF,YAAMS,OAAO,GAAG,MAAM,IAAIF,aAAJ,CAAS;AAC7BG,QAAAA,QAAQ,EAAE,OADmB;AAE7BR,QAAAA,KAF6B;AAG7BC,QAAAA,QAH6B;AAI7BE,QAAAA,QAJ6B;AAK7BD,QAAAA,IAL6B;AAM7BO,QAAAA,MAAM,EAAEC,eAAMC,KAAN,CAAYF,MAAZ;AANqB,OAAT,CAAtB;AASAF,MAAAA,OAAO,CAACK,YAAR,CAAqBL,OAArB,EAA8B,CAACM,GAAD,EAAM5B,IAAN,KAAe;AAC3C,YAAI4B,GAAJ,EAAS,MAAMA,GAAN;AACT9B,QAAAA,GAAG,CAACM,IAAJ,CAAS;AAAES,UAAAA,OAAO,EAAE;AAAX,SAAT,EAF2C,CAEC;AAC7C,OAHD;AAID,KAdD,CAcE,OAAOe,GAAP,EAAY;AACZ,aAAOvB,IAAI,CAACuB,GAAD,CAAX;AACD;AACF,GAxBD,CAwBE,OAAOA,GAAP,EAAY;AACZ,WAAOvB,IAAI,CAACuB,GAAD,CAAX;AACD;AACF,CAnCD,E,CAqCA;;AACAlC,MAAM,CAACmC,GAAP,CAAW,SAAX,EAAsB,CAAChC,GAAD,EAAMC,GAAN,KAAc;AAClCD,EAAAA,GAAG,CAACiC,MAAJ;AACAhC,EAAAA,GAAG,CAACc,IAAJ,CAAS,KAAT;AACD,CAHD;eAKelB,M","sourcesContent":["import { Router } from 'express';\nimport Joi from 'joi';\nimport faker from 'faker';\n\nimport User from '../models/User';\nimport requireLocalAuth from '../middleware/requireLocalAuth';\nimport { registerSchema } from '../services/validators';\n\nconst router = Router();\n\nrouter.post('/login', requireLocalAuth, (req, res) => {\n  const token = req.user.generateJWT();\n  const me = req.user.toJSON();\n  res.json({ token, me });\n});\n\nrouter.post('/register', async (req, res, next) => {\n  const { error } = Joi.validate(req.body, registerSchema);\n  if (error) {\n    return res.status(422).send({ message: error.details[0].message });\n  }\n\n  const { email, password, name, username } = req.body;\n\n  try {\n    const existingUser = await User.findOne({ email });\n\n    if (existingUser) {\n      return res.status(422).send({ message: 'Email is in use' });\n    }\n\n    try {\n      const newUser = await new User({\n        provider: 'email',\n        email,\n        password,\n        username,\n        name,\n        avatar: faker.image.avatar(),\n      });\n\n      newUser.registerUser(newUser, (err, user) => {\n        if (err) throw err;\n        res.json({ message: 'Register success.' }); // just redirect to login\n      });\n    } catch (err) {\n      return next(err);\n    }\n  } catch (err) {\n    return next(err);\n  }\n});\n\n// logout\nrouter.get('/logout', (req, res) => {\n  req.logout();\n  res.send(false);\n});\n\nexport default router;\n"],"file":"localAuth.js"}