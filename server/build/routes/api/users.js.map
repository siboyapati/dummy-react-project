{"version":3,"sources":["../../../src/routes/api/users.js"],"names":["router","storage","multer","diskStorage","destination","req","file","cb","__dirname","filename","fileName","originalname","toLowerCase","split","join","Date","now","upload","fileFilter","mimetype","Error","put","requireJwtAuth","single","res","next","tempUser","User","findById","params","id","status","json","message","user","role","error","body","details","avatarPath","password","provider","existingUser","findOne","username","updatedUser","avatar","name","Object","keys","forEach","k","undefined","findByIdAndUpdate","$set","new","err","get","me","toJSON","users","find","sort","createdAt","map","m","delete","Message","deleteMany","findByIdAndRemove"],"mappings":"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","sourcesContent":["import { Router } from 'express';\nimport multer from 'multer';\nimport { resolve } from 'path';\n\nimport requireJwtAuth from '../../middleware/requireJwtAuth';\nimport User, { hashPassword, validateUser } from '../../models/User';\nimport Message from '../../models/Message';\nimport { seedDb } from '../../utils/seed';\n\nconst router = Router();\n\nconst storage = multer.diskStorage({\n  destination: function (req, file, cb) {\n    cb(null, resolve(__dirname, '../../../public/images'));\n  },\n  filename: function (req, file, cb) {\n    const fileName = file.originalname.toLowerCase().split(' ').join('-');\n    cb(null, `avatar-${Date.now()}-${fileName}`);\n  },\n});\n\nconst upload = multer({\n  storage: storage,\n  fileFilter: (req, file, cb) => {\n    if (file.mimetype == 'image/png' || file.mimetype == 'image/jpg' || file.mimetype == 'image/jpeg') {\n      cb(null, true);\n    } else {\n      cb(null, false);\n      return cb(new Error('Only .png, .jpg and .jpeg format allowed!'));\n    }\n  },\n});\n\n//`checkit`, which is probably the option I'd suggest if  `validatem`\n\nrouter.put('/:id', [requireJwtAuth, upload.single('avatar')], async (req, res, next) => {\n  try {\n    const tempUser = await User.findById(req.params.id);\n    if (!tempUser) return res.status(404).json({ message: 'No such user.' });\n    if (!(tempUser.id === req.user.id || req.user.role === 'ADMIN'))\n      return res.status(400).json({ message: 'You do not have privilegies to edit this user.' });\n\n    //validate name, username and password\n    const { error } = validateUser(req.body);\n    if (error) return res.status(400).json({ message: error.details[0].message });\n\n    let avatarPath = null;\n    if (req.file) {\n      avatarPath = req.file.filename;\n    }\n\n    // if fb or google user provider dont update password\n    let password = null;\n    if (req.user.provider === 'email' && req.body.password && req.body.password !== '') {\n      password = await hashPassword(req.body.password);\n    }\n\n    const existingUser = await User.findOne({ username: req.body.username });\n    if (existingUser && existingUser.id !== tempUser.id) {\n      return res.status(400).json({ message: 'Username alredy taken.' });\n    }\n\n    const updatedUser = { avatar: avatarPath, name: req.body.name, username: req.body.username, password };\n    // remove '', null, undefined\n    Object.keys(updatedUser).forEach((k) => !updatedUser[k] && updatedUser[k] !== undefined && delete updatedUser[k]);\n    // console.log(req.body, updatedUser);\n    const user = await User.findByIdAndUpdate(tempUser.id, { $set: updatedUser }, { new: true });\n\n    res.status(200).json({ user });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong.' });\n  }\n});\n\nrouter.get('/reseed', async (req, res) => {\n  await seedDb();\n  res.json({ message: 'Database reseeded successfully.' });\n});\n\nrouter.get('/me', requireJwtAuth, (req, res) => {\n  const me = req.user.toJSON();\n  res.json({ me });\n});\n\nrouter.get('/:username', requireJwtAuth, async (req, res) => {\n  try {\n    const user = await User.findOne({ username: req.params.username });\n    if (!user) return res.status(404).json({ message: 'No user found.' });\n    res.json({ user: user.toJSON() });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong.' });\n  }\n});\n\nrouter.get('/', requireJwtAuth, async (req, res) => {\n  try {\n    const users = await User.find().sort({ createdAt: 'desc' });\n\n    res.json({\n      users: users.map((m) => {\n        return m.toJSON();\n      }),\n    });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong.' });\n  }\n});\n\nrouter.delete('/:id', requireJwtAuth, async (req, res) => {\n  try {\n    const tempUser = await User.findById(req.params.id);\n    if (!tempUser) return res.status(404).json({ message: 'No such user.' });\n    if (!(tempUser.id === req.user.id || req.user.role === 'ADMIN'))\n      return res.status(400).json({ message: 'You do not have privilegies to delete that user.' });\n\n    // if (['email0@email.com', 'email1@email.com'].includes(tempUser.email))\n    //   return res.status(400).json({ message: 'You can not delete seeded user.' });\n\n    //delete all messages from that user\n    await Message.deleteMany({ user: tempUser.id });\n    //delete user\n    const user = await User.findByIdAndRemove(tempUser.id);\n    res.status(200).json({ user });\n  } catch (err) {\n    res.status(500).json({ message: 'Something went wrong.' });\n  }\n});\n\nexport default router;\n"],"file":"users.js"}